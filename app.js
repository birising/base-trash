const dataKose = [
  {
    lat: 50.130144,
    lng: 14.219936,
    name: "Koš plný",
    description: null,
    category: "kos",
    fillLevel: 92,
    lastUpdated: "2024-05-12 08:15",
    batteryLevel: 34,
  },
  {
    lat: 50.128687,
    lng: 14.221423,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 38,
    lastUpdated: "2024-05-12 09:02",
    batteryLevel: 78,
  },
  {
    lat: 50.129602,
    lng: 14.221984,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 56,
    lastUpdated: "2024-05-11 18:41",
    batteryLevel: 82,
  },
  {
    lat: 50.132469,
    lng: 14.220607,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 21,
    lastUpdated: "2024-05-12 06:58",
    batteryLevel: 64,
  },
  {
    lat: 50.132801,
    lng: 14.220461,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 49,
    lastUpdated: "2024-05-11 22:16",
    batteryLevel: 59,
  },
  {
    lat: 50.133472,
    lng: 14.225753,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 73,
    lastUpdated: "2024-05-12 07:45",
    batteryLevel: 41,
  },
  {
    lat: 50.132557,
    lng: 14.220691,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 12,
    lastUpdated: "2024-05-12 08:55",
    batteryLevel: 91,
  },
];

const dataKontejnery = [
  { lat: 50.132911, lng: 14.224212, name: "Zimni udrzba", description: null, category: "zimni_udrzba" },
  { lat: 50.132602, lng: 14.224192, name: "Zimni udrzba", description: null, category: "zimni_udrzba" },
  { lat: 50.130817, lng: 14.221791, name: "Zimni udrba", description: null, category: "zimni_udrzba" },
  { lat: 50.132204, lng: 14.222392, name: "Zimni idezba", description: null, category: "zimni_udrzba" },
];

const dataLampy = [
  { lat: 50.133935, lng: 14.222031, name: "Rozbita lampa", description: null, category: "lampy" },
  { lat: 50.132683, lng: 14.22153, name: "Rozbita", description: null, category: "lampy" },
  { lat: 50.130526, lng: 14.220269, name: "Lampa rozbita", description: null, category: "lampy" },
  { lat: 50.132075, lng: 14.225998, name: "Lampa rozbita", description: null, category: "lampy" },
  { lat: 50.130589, lng: 14.221878, name: "Lampa 15", description: null, category: "lampy" },
  { lat: 50.130105, lng: 14.222052, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131003, lng: 14.221204, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.13117, lng: 14.220722, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.130949, lng: 14.220521, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.130093, lng: 14.219836, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.129781, lng: 14.219071, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131421, lng: 14.220844, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132316, lng: 14.220784, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132836, lng: 14.220645, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133054, lng: 14.220365, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133314, lng: 14.21992, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133076, lng: 14.219179, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133666, lng: 14.220194, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133295, lng: 14.221099, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133599, lng: 14.221485, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133897, lng: 14.221747, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132773, lng: 14.221132, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132649, lng: 14.22213, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132459, lng: 14.222365, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132207, lng: 14.222406, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132609, lng: 14.222559, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132825, lng: 14.222919, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133015, lng: 14.223248, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.13304, lng: 14.223699, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132968, lng: 14.2241, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133074, lng: 14.224404, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133565, lng: 14.224416, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133423, lng: 14.224041, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133372, lng: 14.224993, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132633, lng: 14.224092, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132452, lng: 14.223862, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132232, lng: 14.224346, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132147, lng: 14.225015, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132281, lng: 14.223662, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132101, lng: 14.222946, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132001, lng: 14.222607, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131776, lng: 14.22183, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131564, lng: 14.221154, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131401, lng: 14.22157, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131108, lng: 14.221686, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.130743, lng: 14.220386, name: "lampa", description: null, category: "lampy" },
];

function showMapError(message) {
  const mapContainer = document.getElementById("map");
  if (!mapContainer) return;
  mapContainer.innerHTML = `<div class="map-error">${message}</div>`;
}

window.addEventListener("DOMContentLoaded", () => {
  if (!window.L) {
    showMapError("Mapový modul se nepodařilo načíst. Zkuste obnovit stránku.");
    return;
  }

  const map = L.map("map", {
    zoomControl: false,
    attributionControl: false,
  });

  const baseLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "© OpenStreetMap přispěvatelé",
  });
  baseLayer.addTo(map);

  const toolbarZoom = L.control.zoom({ position: "topright" });
  toolbarZoom.addTo(map);

  const defaultView = [50.1322, 14.222];
  map.setView(defaultView, 16);

  map.whenReady(() => refreshMapSize(0));

  function refreshMapSize(delay = 120) {
    setTimeout(() => map.invalidateSize(), delay);
  }

  const iconColors = {
    kose: "#34e39f",
    lampy: "#f28c38",
    kontejnery: "#4ab7ff",
  };

  const layers = {
    kose: L.layerGroup(),
    lampy: L.layerGroup(),
    kontejnery: L.layerGroup(),
  };

  const counters = {
    kose: document.getElementById("countKose"),
    lampy: document.getElementById("countLampy"),
    kontejnery: document.getElementById("countKontejnery"),
  };

  const categoryLabel = document.getElementById("activeCategoryLabel");

  function createMarker(item, color) {
    const { lat, lng, name } = item;
    const circle = L.circleMarker([lat, lng], {
      radius: 8,
      color,
      weight: 2,
      fillColor: color,
      fillOpacity: 0.85,
    });

    let popupContent = `<strong>${name}</strong>`;
    if (item.category === "kos") {
      const fill = item.fillLevel != null ? `${item.fillLevel}%` : "–";
      const battery = item.batteryLevel != null ? `${item.batteryLevel}%` : "–";
      const updated = item.lastUpdated || "–";
      popupContent += `
        <div class="popup-details">
          <div><span>Naplněnost:</span><strong>${fill}</strong></div>
          <div><span>Poslední aktualizace:</span><strong>${updated}</strong></div>
          <div><span>Stav baterie:</span><strong>${battery}</strong></div>
        </div>`;
    }

    circle.bindPopup(popupContent);
    return circle;
  }

  function populateLayer(category) {
    layers[category].clearLayers();
    let source = [];
    if (category === "kose") source = dataKose;
    if (category === "lampy") source = dataLampy;
    if (category === "kontejnery") source = dataKontejnery;

    source.forEach((item) => {
      const marker = createMarker(item, iconColors[category]);
      marker.addTo(layers[category]);
    });
  }

  populateLayer("kose");
  populateLayer("lampy");
  populateLayer("kontejnery");

  function updateCounters() {
    if (counters.kose) counters.kose.textContent = dataKose.length;
    if (counters.lampy) counters.lampy.textContent = dataLampy.length;
    if (counters.kontejnery) counters.kontejnery.textContent = dataKontejnery.length;
  }

  updateCounters();

  Object.values(layers).forEach((layer) => layer.addTo(map));

  function setActiveCategory(category) {
    Object.entries(layers).forEach(([key, layer]) => {
      if (key === category) {
        map.addLayer(layer);
      } else {
        map.removeLayer(layer);
      }
    });

    const activeButton = document.querySelector('.nav-item.active');
    if (activeButton) activeButton.classList.remove('active');
    const targetButton = document.querySelector(`.nav-item[data-category="${category}"]`);
    if (targetButton) targetButton.classList.add('active');

    const activeStat = document.querySelector('.stat-card.active');
    if (activeStat) activeStat.classList.remove('active');
    const targetStat = document.querySelector(`.stat-card[data-category="${category}"]`);
    if (targetStat) targetStat.classList.add('active');

    const activeData =
      category === "kose" ? dataKose : category === "lampy" ? dataLampy : dataKontejnery;
    const coords = activeData.map((item) => [item.lat, item.lng]);
    if (coords.length) {
      const bounds = L.latLngBounds(coords);
      map.flyToBounds(bounds, { padding: [28, 28], duration: 0.6, easeLinearity: 0.25 });
    }

    if (categoryLabel) {
      const labelText = category === "kose" ? "Koše" : category === "lampy" ? "Lampy" : "Kontejnery";
      categoryLabel.textContent = `${labelText}`;
    }

    refreshMapSize();
  }

  function setupSidebarToggle() {
    const sidebar = document.getElementById("sidebar");
    const menuToggle = document.getElementById("menuToggle");
    const backdrop = document.createElement("div");
    backdrop.className = "overlay-backdrop";
    document.body.appendChild(backdrop);

    function ensureInitialState() {
      if (window.innerWidth <= 960) {
        sidebar.classList.add("sidebar-hidden");
      } else {
        sidebar.classList.remove("sidebar-hidden");
      }
    }

    function openSidebar() {
      document.body.classList.add("overlay-visible");
      sidebar.classList.remove("sidebar-hidden");
      menuToggle.setAttribute("aria-expanded", "true");
      refreshMapSize();
    }

    function closeSidebar() {
      document.body.classList.remove("overlay-visible");
      sidebar.classList.add("sidebar-hidden");
      menuToggle.setAttribute("aria-expanded", "false");
      refreshMapSize();
    }

    menuToggle.addEventListener("click", () => {
      if (document.body.classList.contains("overlay-visible")) {
        closeSidebar();
      } else {
        openSidebar();
      }
    });

    backdrop.addEventListener("click", closeSidebar);

    const mediaQuery = window.matchMedia("(min-width: 961px)");
    mediaQuery.addEventListener("change", (e) => {
      if (e.matches) {
        document.body.classList.remove("overlay-visible");
        sidebar.classList.remove("sidebar-hidden");
        menuToggle.setAttribute("aria-expanded", "false");
        refreshMapSize();
      } else {
        sidebar.classList.add("sidebar-hidden");
        refreshMapSize();
      }
    });

    ensureInitialState();
  }

  function initNav() {
    const buttonSelectors = [".nav-item", ".stat-card"];
    buttonSelectors.forEach((selector) => {
      document.querySelectorAll(selector).forEach((btn) =>
        btn.addEventListener("click", () => {
          const category = btn.dataset.category;
          setActiveCategory(category);
          if (window.innerWidth <= 960) {
            document.body.classList.remove("overlay-visible");
            document.getElementById("sidebar").classList.add("sidebar-hidden");
            document.getElementById("menuToggle").setAttribute("aria-expanded", "false");
          }
        })
      );
    });
  }

  setActiveCategory("kose");
  setupSidebarToggle();
  initNav();
  refreshMapSize(0);
  window.addEventListener("resize", () => refreshMapSize(80));
});
