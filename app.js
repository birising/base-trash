const dataKose = [
  {
    lat: 50.130144,
    lng: 14.219936,
    name: "Koš plný",
    description: null,
    category: "kos",
    fillLevel: 92,
    lastUpdated: "2024-05-12 08:15",
    batteryLevel: 34,
  },
  {
    lat: 50.128687,
    lng: 14.221423,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 38,
    lastUpdated: "2024-05-12 09:02",
    batteryLevel: 78,
  },
  {
    lat: 50.129602,
    lng: 14.221984,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 56,
    lastUpdated: "2024-05-11 18:41",
    batteryLevel: 82,
  },
  {
    lat: 50.132469,
    lng: 14.220607,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 21,
    lastUpdated: "2024-05-12 06:58",
    batteryLevel: 64,
  },
  {
    lat: 50.132801,
    lng: 14.220461,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 49,
    lastUpdated: "2024-05-11 22:16",
    batteryLevel: 59,
  },
  {
    lat: 50.133472,
    lng: 14.225753,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 73,
    lastUpdated: "2024-05-12 07:45",
    batteryLevel: 41,
  },
  {
    lat: 50.132557,
    lng: 14.220691,
    name: "Koš",
    description: null,
    category: "kos",
    fillLevel: 12,
    lastUpdated: "2024-05-12 08:55",
    batteryLevel: 91,
  },
];

const dataKontejnery = [
  { lat: 50.132911, lng: 14.224212, name: "Zimni udrzba", description: null, category: "zimni_udrzba" },
  { lat: 50.132602, lng: 14.224192, name: "Zimni udrzba", description: null, category: "zimni_udrzba" },
  { lat: 50.130817, lng: 14.221791, name: "Zimni udrba", description: null, category: "zimni_udrzba" },
  { lat: 50.132204, lng: 14.222392, name: "Zimni idezba", description: null, category: "zimni_udrzba" },
];

const dataLampy = [
  { lat: 50.133935, lng: 14.222031, name: "Rozbita lampa", description: null, category: "lampy" },
  { lat: 50.132683, lng: 14.22153, name: "Rozbita", description: null, category: "lampy" },
  { lat: 50.130526, lng: 14.220269, name: "Lampa rozbita", description: null, category: "lampy" },
  { lat: 50.132075, lng: 14.225998, name: "Lampa rozbita", description: null, category: "lampy" },
  { lat: 50.130589, lng: 14.221878, name: "Lampa 15", description: null, category: "lampy" },
  { lat: 50.130105, lng: 14.222052, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131003, lng: 14.221204, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.13117, lng: 14.220722, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.130949, lng: 14.220521, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.130093, lng: 14.219836, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.129781, lng: 14.219071, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131421, lng: 14.220844, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132316, lng: 14.220784, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132836, lng: 14.220645, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133054, lng: 14.220365, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133314, lng: 14.21992, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133076, lng: 14.219179, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133666, lng: 14.220194, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133295, lng: 14.221099, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133599, lng: 14.221485, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133897, lng: 14.221747, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132773, lng: 14.221132, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132649, lng: 14.22213, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132459, lng: 14.222365, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132207, lng: 14.222406, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132609, lng: 14.222559, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132825, lng: 14.222919, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133015, lng: 14.223248, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.13304, lng: 14.223699, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132968, lng: 14.2241, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133074, lng: 14.224404, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133565, lng: 14.224416, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133423, lng: 14.224041, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.133372, lng: 14.224993, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132633, lng: 14.224092, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132452, lng: 14.223862, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132232, lng: 14.224346, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132147, lng: 14.225015, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132281, lng: 14.223662, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132101, lng: 14.222946, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.132001, lng: 14.222607, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131776, lng: 14.22183, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131564, lng: 14.221154, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131401, lng: 14.22157, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.131108, lng: 14.221686, name: "Lampa", description: null, category: "lampy" },
  { lat: 50.130743, lng: 14.220386, name: "lampa", description: null, category: "lampy" },
];

const dataHladina = [
  {
    lat: 50.1309,
    lng: 14.2227,
    name: "Senzor hladiny potoka",
    description: "Běloky – úroveň vody",
    category: "hladina",
    sensorId: 24470,
  },
];

const streamEndpoint = "https://hladiny-vox.pwsplus.eu/Senzors/Details/24470";
const floodThresholds = [
  { label: "SPA 1", value: 90, color: "#22c55e" },
  { label: "SPA 2", value: 100, color: "#facc15" },
  { label: "SPA 3", value: 120, color: "#f97316" },
];
function buildHistory(hours = 72, start = 38, variance = 4) {
  const history = [];
  for (let i = 0; i < hours; i += 1) {
    const wave = Math.sin(i / 8) * 1.5;
    const drift = i * 0.02;
    const micro = Math.cos(i / 5) * 0.8;
    const swing = ((i % 12) / 12) * (variance * 0.6);
    const value = Math.max(24, Math.round((start + wave + drift + micro + swing) * 10) / 10);
    history.push(value);
  }
  return history;
}

let streamHistory = buildHistory();
const streamState = {
  level: `${streamHistory.at(-1)} cm`,
  updated: "Základní údaje",
  numeric: streamHistory.at(-1),
  status: "Načítám…",
};

function showMapError(message) {
  const mapContainer = document.getElementById("map");
  if (!mapContainer) return;
  mapContainer.innerHTML = `<div class="map-error">${message}</div>`;
}

window.addEventListener("DOMContentLoaded", () => {
  if (!window.L) {
    showMapError("Mapový modul se nepodařilo načíst. Zkuste obnovit stránku.");
    return;
  }

  const map = L.map("map", {
    zoomControl: false,
    attributionControl: false,
  });

  const baseLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "© OpenStreetMap přispěvatelé",
  });
  baseLayer.addTo(map);

  const toolbarZoom = L.control.zoom({ position: "topright" });
  toolbarZoom.addTo(map);

  const defaultView = [50.1322, 14.222];
  map.setView(defaultView, 16);

  map.whenReady(() => refreshMapSize(0));

  function refreshMapSize(delay = 120) {
    setTimeout(() => map.invalidateSize(), delay);
  }

  const iconColors = {
    kose: "#34e39f",
    lampy: "#f28c38",
    kontejnery: "#4ab7ff",
    hladina: "#7c3aed",
  };

  const layers = {
    kose: L.layerGroup(),
    lampy: L.layerGroup(),
    kontejnery: L.layerGroup(),
    hladina: L.layerGroup(),
  };

  const counters = {
    kose: document.getElementById("countKose"),
    lampy: document.getElementById("countLampy"),
    kontejnery: document.getElementById("countKontejnery"),
    hladina: document.getElementById("countHladina"),
  };

  const levelReading = document.getElementById("levelReading");
  const streamLevelEl = document.getElementById("streamLevel");
  const streamUpdatedEl = document.getElementById("streamUpdated");
  const streamStatusEl = document.getElementById("streamStatus");

  const categoryLabel = document.getElementById("activeCategoryLabel");
  const mapOverlay = document.getElementById("mapOverlay");
  const mapView = document.getElementById("mapView");
  const streamView = document.getElementById("streamView");

  function renderStreamChart(latestValue = null) {
    const chart = document.getElementById("levelChart");
    if (!chart) return;

    const series = [...streamHistory];
    const normalizedLatest = latestValue != null ? latestValue : streamState.numeric;
    if (normalizedLatest != null) {
      series.push(normalizedLatest);
    }

    while (series.length > 72) series.shift();

    const width = 540;
    const height = 260;
    const padding = 32;

    const thresholdValues = floodThresholds.map((t) => t.value);
    const minVal = Math.min(...series, ...thresholdValues) - 4;
    const maxVal = Math.max(...series, ...thresholdValues) + 6;
    const range = Math.max(maxVal - minVal, 1);

    const points = series.map((val, idx) => {
      const x = padding + (idx / (series.length - 1)) * (width - padding * 2);
      const y = height - padding - ((val - minVal) / range) * (height - padding * 2);
      return { x, y };
    });

    const pathD = points.map((p, idx) => `${idx === 0 ? "M" : "L"}${p.x},${p.y}`).join(" ");
    const areaD = `${pathD} L${points.at(-1).x},${height - padding} L${points[0].x},${height - padding} Z`;

    const gridLines = [0.25, 0.5, 0.75].map((ratio) => {
      const y = padding + (height - padding * 2) * ratio;
      return `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" class="chart-grid" />`;
    }).join("");

    chart.innerHTML = `
      <defs>
        <linearGradient id="areaGradient" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0%" stop-color="#6ff0d5" stop-opacity="0.35" />
          <stop offset="100%" stop-color="#6ff0d5" stop-opacity="0" />
        </linearGradient>
      </defs>
      <rect x="${padding}" y="${padding}" width="${width - padding * 2}" height="${height - padding * 2}" rx="12" class="chart-frame" />
      ${gridLines}
      ${floodThresholds
        .map((t) => {
          const y = height - padding - ((t.value - minVal) / range) * (height - padding * 2);
          return `
            <line x1="${padding}" x2="${width - padding}" y1="${y}" y2="${y}" class="threshold-line" stroke="${t.color}" />
            <text x="${width - padding + 6}" y="${y + 4}" class="threshold-label" fill="${t.color}">${t.label} · ${t.value} cm</text>
          `;
        })
        .join("")}
      <path d="${areaD}" class="chart-area" />
      <path d="${pathD}" class="chart-line" />
      ${points
        .map((p, idx) => {
          const isTick = idx % 12 === 0 || idx === points.length - 1;
          const hoursAgo = points.length - 1 - idx;
          const label = idx === points.length - 1 ? "Nyní" : `-${hoursAgo}h`;
          return `
            <circle cx="${p.x}" cy="${p.y}" r="4" class="chart-dot" />
            ${isTick ? `<text x="${p.x}" y="${height - padding + 16}" class="chart-label">${label}</text>` : ""}
          `;
        })
        .join("")}
      <text x="${points.at(-1).x}" y="${points.at(-1).y - 12}" class="chart-value">${series.at(-1)} cm</text>
    `;
  }

  function createMarker(item, color) {
    const { lat, lng, name } = item;
    const circle = L.circleMarker([lat, lng], {
      radius: 8,
      color,
      weight: 2,
      fillColor: color,
      fillOpacity: 0.85,
    });

    let popupContent = `<strong>${name}</strong>`;
    if (item.category === "kos") {
      const fill = item.fillLevel != null ? `${item.fillLevel}%` : "–";
      const battery = item.batteryLevel != null ? `${item.batteryLevel}%` : "–";
      const updated = item.lastUpdated || "–";
      popupContent += `
        <div class="popup-details">
          <div><span>Naplněnost:</span><strong>${fill}</strong></div>
          <div><span>Poslední aktualizace:</span><strong>${updated}</strong></div>
          <div><span>Stav baterie:</span><strong>${battery}</strong></div>
        </div>`;
    } else if (item.category === "hladina") {
      const levelText = streamState.level ? `${streamState.level}` : "Načítám…";
      const updatedText = streamState.updated || "–";
      popupContent += `
        <div class="popup-details">
          <div><span>Úroveň vody:</span><strong>${levelText}</strong></div>
          <div><span>Poslední data:</span><strong>${updatedText}</strong></div>
        </div>`;
    }

    circle.bindPopup(popupContent);
    return circle;
  }

  function populateLayer(category) {
    layers[category].clearLayers();
    let source = [];
    if (category === "kose") source = dataKose;
    if (category === "lampy") source = dataLampy;
    if (category === "kontejnery") source = dataKontejnery;
    if (category === "hladina") source = dataHladina;

    source.forEach((item) => {
      const marker = createMarker(item, iconColors[category]);
      marker.addTo(layers[category]);
    });
  }

  populateLayer("kose");
  populateLayer("lampy");
  populateLayer("kontejnery");
  populateLayer("hladina");

  function updateCounters() {
    if (counters.kose) counters.kose.textContent = dataKose.length;
    if (counters.lampy) counters.lampy.textContent = dataLampy.length;
    if (counters.kontejnery) counters.kontejnery.textContent = dataKontejnery.length;
    if (counters.hladina) {
      counters.hladina.textContent = streamState.level ? streamState.level : `${dataHladina.length} senzor`;
    }
    if (levelReading) {
      const levelText = streamState.level ? `Aktuální: ${streamState.level}` : "Načítám data senzorů…";
      const stamp = streamState.updated ? ` · ${streamState.updated}` : "";
      levelReading.textContent = `${levelText}${stamp}`;
    }
    if (streamLevelEl) streamLevelEl.textContent = streamState.level || "–";
    if (streamUpdatedEl) {
      streamUpdatedEl.textContent = streamState.updated ? `Aktualizace: ${streamState.updated}` : "Načítám…";
    }
    if (streamStatusEl) streamStatusEl.textContent = streamState.status || "–";
    renderStreamChart(streamState.numeric);
  }

  updateCounters();

  Object.values(layers).forEach((layer) => layer.addTo(map));

  function setActiveCategory(category) {
    const isStreamView = category === "hladina";
    Object.entries(layers).forEach(([key, layer]) => {
      if (key === category) {
        map.addLayer(layer);
      } else {
        map.removeLayer(layer);
      }
    });

    const activeButton = document.querySelector('.nav-item.active');
    if (activeButton) activeButton.classList.remove('active');
    const targetButton = document.querySelector(`.nav-item[data-category="${category}"]`);
    if (targetButton) targetButton.classList.add('active');

    const activeStat = document.querySelector('.stat-card.active');
    if (activeStat) activeStat.classList.remove('active');
    const targetStat = document.querySelector(`.stat-card[data-category="${category}"]`);
    if (targetStat) targetStat.classList.add('active');

    if (!isStreamView) {
      const activeData =
        category === "kose"
          ? dataKose
          : category === "lampy"
            ? dataLampy
            : category === "kontejnery"
              ? dataKontejnery
              : dataHladina;
      const coords = activeData.map((item) => [item.lat, item.lng]);
      if (coords.length) {
        const bounds = L.latLngBounds(coords);
        map.flyToBounds(bounds, { padding: [28, 28], duration: 0.6, easeLinearity: 0.25 });
      }
    }

    if (categoryLabel) {
      const labelText =
        category === "kose"
          ? "Koše"
          : category === "lampy"
            ? "Lampy"
            : category === "kontejnery"
              ? "Kontejnery"
              : "Hladina potoka";
      categoryLabel.textContent = `${labelText}`;
    }

    if (mapOverlay) mapOverlay.classList.toggle("hidden", isStreamView);
    if (mapView) mapView.classList.toggle("hidden", isStreamView);
    if (streamView) streamView.classList.toggle("hidden", !isStreamView);

    if (!isStreamView) {
      refreshMapSize();
    }
  }

  function setupSidebarToggle() {
    const sidebar = document.getElementById("sidebar");
    const menuToggle = document.getElementById("menuToggle");
    const backdrop = document.createElement("div");
    backdrop.className = "overlay-backdrop";
    document.body.appendChild(backdrop);

    function ensureInitialState() {
      if (window.innerWidth <= 960) {
        sidebar.classList.add("sidebar-hidden");
      } else {
        sidebar.classList.remove("sidebar-hidden");
      }
    }

    function openSidebar() {
      document.body.classList.add("overlay-visible");
      sidebar.classList.remove("sidebar-hidden");
      menuToggle.setAttribute("aria-expanded", "true");
      refreshMapSize();
    }

    function closeSidebar() {
      document.body.classList.remove("overlay-visible");
      sidebar.classList.add("sidebar-hidden");
      menuToggle.setAttribute("aria-expanded", "false");
      refreshMapSize();
    }

    menuToggle.addEventListener("click", () => {
      if (document.body.classList.contains("overlay-visible")) {
        closeSidebar();
      } else {
        openSidebar();
      }
    });

    backdrop.addEventListener("click", closeSidebar);

    const mediaQuery = window.matchMedia("(min-width: 961px)");
    mediaQuery.addEventListener("change", (e) => {
      if (e.matches) {
        document.body.classList.remove("overlay-visible");
        sidebar.classList.remove("sidebar-hidden");
        menuToggle.setAttribute("aria-expanded", "false");
        refreshMapSize();
      } else {
        sidebar.classList.add("sidebar-hidden");
        refreshMapSize();
      }
    });

    ensureInitialState();
  }

  function initNav() {
    const buttonSelectors = [".nav-item", ".stat-card"];
    buttonSelectors.forEach((selector) => {
      document.querySelectorAll(selector).forEach((btn) =>
        btn.addEventListener("click", () => {
          const category = btn.dataset.category;
          setActiveCategory(category);
          if (window.innerWidth <= 960) {
            document.body.classList.remove("overlay-visible");
            document.getElementById("sidebar").classList.add("sidebar-hidden");
            document.getElementById("menuToggle").setAttribute("aria-expanded", "false");
          }
        })
      );
    });
  }

  async function fetchStreamLevel() {
    try {
      const response = await fetch(streamEndpoint, { cache: "no-store" });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      const valueCandidate =
        doc.querySelector(".sensor-value, .value, .measurement, .card-body strong")?.textContent ||
        doc.querySelector("[data-value]")?.getAttribute("data-value");
      const timeCandidate =
        doc.querySelector("time")?.textContent ||
        doc.querySelector(".timestamp")?.textContent;

      const valueFromText = (() => {
        const match = html.match(/([0-9]+(?:[.,][0-9]+)?)\s*(cm|m)/i);
        if (match) return `${match[1].replace(",", ".")} ${match[2]}`;
        return valueCandidate ? valueCandidate.trim() : null;
      })();

      const timeFromText = (() => {
        const match = html.match(/(\d{1,2}\.\d{1,2}\.\d{4}[^\d]*\d{1,2}:\d{2})/);
        if (match) return match[1];
        return timeCandidate ? timeCandidate.trim() : null;
      })();

      streamState.level = valueFromText || streamState.level;
      streamState.updated = timeFromText || streamState.updated || new Date().toLocaleString("cs-CZ");
      const numericMatch = (valueFromText || "").match(/([0-9]+(?:[.,][0-9]+)?)/);
      streamState.numeric = numericMatch ? parseFloat(numericMatch[1].replace(",", ".")) : streamState.numeric;
      if (streamState.numeric != null && !Number.isNaN(streamState.numeric)) {
        streamHistory = [...streamHistory.slice(-(72 - 1)), streamState.numeric];
      }
      streamState.status = `Live data · ${new Date().toLocaleTimeString("cs-CZ")}`;
    } catch (err) {
      streamState.level = streamState.level || `${streamHistory.at(-1)} cm`;
      streamState.updated = streamState.updated || "Zdroj nepřístupný";
      streamState.numeric = streamState.numeric || streamHistory.at(-1);
      streamState.status = "Zdroj nepřístupný";
      console.warn("Chyba při načítání hladiny", err);
    } finally {
      populateLayer("hladina");
      updateCounters();
    }
  }

  setActiveCategory("kose");
  setupSidebarToggle();
  initNav();
  refreshMapSize(0);
  window.addEventListener("resize", () => refreshMapSize(80));
  fetchStreamLevel();
});
